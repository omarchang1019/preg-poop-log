<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ‹‰äº†ä¹ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- å›¾æ ‡ï¼ˆæŒ‰ä½ çš„å®é™…æ–‡ä»¶åæ¥æ”¹ï¼‰ -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", sans-serif;
      background: radial-gradient(circle at top, #ffe8d9 0, #fff7f0 40%, #fff 100%);
      color: #222;
    }

    .app {
      max-width: 640px;
      margin: 0 auto;
      padding: 18px 16px 32px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: #ffe0c7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    h1 {
      font-size: 22px;
      margin: 0;
      color: #543326;
    }

    .subtitle {
      font-size: 12px;
      color: #8c6f5b;
      margin-bottom: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow:
        0 18px 40px rgba(180, 120, 80, 0.08),
        0 1px 2px rgba(0,0,0,0.04);
      margin-bottom: 14px;
      border: 1px solid rgba(255, 186, 140, 0.18);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #5b3a29;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.emoji {
      font-size: 16px;
    }

    .card-subtitle {
      font-size: 11px;
      color: #b08a70;
      margin-bottom: 4px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #6b4b36;
    }

    input, select, textarea {
      width: 100%;
      padding: 9px 11px;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid #e6d4c7;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      background: #fffdfb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #ff9e73;
      box-shadow: 0 0 0 2px rgba(255, 158, 115, 0.18);
      background: #fffbf7;
    }

    textarea {
      resize: vertical;
      min-height: 64px;
    }

    .form-row {
      margin-bottom: 10px;
    }

    .form-row-inline {
      display: flex;
      gap: 8px;
    }

    .form-row-inline .form-row {
      flex: 1;
      margin-bottom: 0;
    }

    .btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 10px 14px;
      font-size: 15px;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      letter-spacing: 0.2px;
      transition: transform 0.06s ease, box-shadow 0.12s ease, background-color 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff9f7b, #ffb88a);
      color: #fff;
      box-shadow: 0 8px 16px rgba(255, 147, 101, 0.26);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(255, 147, 101, 0.2);
      background: linear-gradient(135deg, #ff8a5c, #ffaf7a);
    }

    .btn-secondary {
      background: #fff3e8;
      color: #8a5b3a;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(190, 130, 90, 0.06);
      margin-top: 6px;
    }

    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(190, 130, 90, 0.1);
      background: #ffe6d2;
    }

    .btn-text {
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid #f0d8c7;
      margin-top: 6px;
      font-size: 13px;
      color: #8a5b3a;
      box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }

    .btn-text:active {
      background: #fff5ed;
    }

    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .records-header-title {
      font-size: 15px;
      font-weight: 600;
      color: #5b3a29;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .records-header-title span.emoji {
      font-size: 15px;
    }

    .filter-select {
      width: auto;
      padding: 5px 9px;
      font-size: 12px;
      border-radius: 999px;
      background: #fffaf5;
      border-color: #f1d6c4;
      color: #7b5942;
    }

    .record-list {
      max-height: 60vh;
      overflow-y: auto;
      padding-top: 2px;
    }

    .record-item {
      padding: 8px 6px 6px;
      border-bottom: 1px dashed #f0dfd3;
    }

    .record-item:last-child {
      border-bottom: none;
    }

    .record-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .record-time {
      font-size: 13px;
      font-weight: 500;
      color: #68412f;
    }

    .record-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #ffe9da;
      color: #8a5330;
      margin-left: 4px;
    }

    .record-sub {
      font-size: 12px;
      color: #99735b;
      margin-bottom: 2px;
    }

    .record-note {
      font-size: 12px;
      color: #5f4c41;
      white-space: pre-wrap;
      background: #fff6ef;
      border-radius: 10px;
      padding: 4px 8px;
      margin-bottom: 4px;
    }

    .record-actions {
      text-align: right;
      margin-top: 2px;
    }

    .link-btn {
      border: none;
      background: none;
      font-size: 12px;
      padding: 2px 4px;
      cursor: pointer;
      margin-left: 4px;
      color: #ff985d;
    }

    .link-btn-danger {
      color: #ff4f4f;
    }

    .empty-tip {
      font-size: 12px;
      color: #b79a86;
      text-align: center;
      padding: 12px 4px 6px;
    }

    .footer-tip {
      text-align: center;
      font-size: 11px;
      color: #a0826c;
      margin-top: 4px;
    }

    .editing-tip {
      margin-top: 6px;
      font-size: 11px;
      color: #b05a24;
      text-align: left;
    }

    .backup-note {
      font-size: 11px;
      color: #8f7461;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* ä¸Šæ¬¡æ’ä¾¿æ—¶é—´é¢æ¿ */
    #lastPoopPanel {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .last-poop-text {
      font-size: 16px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #fff6ed;
      color: #5b3a29;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .last-poop-text span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ff8f5d;
      box-shadow: 0 0 0 4px rgba(255, 143, 93, 0.18);
    }

    .last-poop-text-empty {
      background: #f9f0ea;
      color: #a28a79;
      box-shadow: none;
    }

    .last-poop-sub {
      font-size: 12px;
      color: #b08a70;
    }

    /* å¤‡ä»½æ–‡æœ¬æ¡†ç¨å¾®æŸ”å’Œä¸€ç‚¹ */
    #backupTextarea {
      background: #fffaf6;
      font-size: 12px;
      line-height: 1.4;
    }

    @media (min-width: 600px) {
      body {
        background: radial-gradient(circle at top, #ffe1cf 0, #fff5eb 45%, #ffffff 100%);
      }
      .app {
        padding: 24px 20px 40px;
      }
      #backupTextarea {
        min-height: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-icon">ğŸ’©</div>
      <div>
        <h1>å­•æœŸæ’ä¾¿è®°å½•</h1>
        <div class="subtitle">æ¸©æŸ”è®°å½•æ¯ä¸€å¤©çš„å°å°è¿›å±• Â· æ•°æ®åªåœ¨è¿™å°è®¾å¤‡ä¸Š</div>
      </div>
    </div>

    <!-- ä¸Šæ¬¡æ’ä¾¿æ—¶é—´é¢æ¿ -->
    <div class="card" id="lastPoopPanel">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">â°</span>
          <span>ä¸Šæ¬¡æ’ä¾¿æ—¶é—´</span>
        </div>
      </div>
      <div id="lastPoopText" class="last-poop-text last-poop-text-empty">
        æš‚æ— è®°å½•
      </div>
      <div class="last-poop-sub">
        æç¤ºï¼šè®°å½•è¶ŠåŠæ—¶ï¼Œè¿™é‡Œæ˜¾ç¤ºçš„æ—¶é—´å°±è¶Šå‡†ç¡®ã€‚
      </div>
    </div>

    <!-- å½•å…¥å¡ç‰‡ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">ğŸ“</span>
          <span>ä»Šæ—¥è®°å½•</span>
        </div>
      </div>
      <div class="card-subtitle">ç®€å•å‡ é¡¹ï¼Œå¸®ä½ ä»¬ä¸€èµ·è§‚å¯Ÿè‚ é“çŠ¶æ€ï½</div>

      <form id="poopForm">
        <div class="form-row-inline">
          <div class="form-row">
            <label for="dateInput">æ—¥æœŸ</label>
            <input type="date" id="dateInput" required />
          </div>
          <div class="form-row">
            <label for="timeInput">æ—¶é—´</label>
            <input type="time" id="timeInput" required />
          </div>
        </div>

        <div class="form-row">
          <label for="shapeInput">æ€§çŠ¶ï¼ˆå¤§è‡´å½¢æ€ï¼‰</label>
          <select id="shapeInput" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="åç¡¬">åç¡¬</option>
            <option value="æ­£å¸¸æˆå½¢">æ­£å¸¸æˆå½¢</option>
            <option value="åè½¯">åè½¯</option>
            <option value="ç¨€/æ¥è¿‘è…¹æ³»">ç¨€ / æ¥è¿‘è…¹æ³»</option>
          </select>
        </div>

        <div class="form-row">
          <label for="amountInput">é‡</label>
          <select id="amountInput" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="å°‘">å°‘</option>
            <option value="ä¸­ç­‰">ä¸­ç­‰</option>
            <option value="å¤š">å¤š</option>
          </select>
        </div>

        <div class="form-row">
          <label for="feelingInput">æ’ä¾¿æ„Ÿå—</label>
          <select id="feelingInput">
            <option value="">å¯é€‰</option>
            <option value="è½»æ¾">è½»æ¾</option>
            <option value="æœ‰ç‚¹è´¹åŠ²">æœ‰ç‚¹è´¹åŠ²</option>
            <option value="å¾ˆè´¹åŠ²/ä¾¿ç§˜æ„Ÿ">å¾ˆè´¹åŠ² / ä¾¿ç§˜æ„Ÿ</option>
            <option value="è…¹ç—›">è…¹ç—›</option>
            <option value="è‚›é—¨ä¸é€‚">è‚›é—¨ä¸é€‚</option>
          </select>
        </div>

        <div class="form-row">
          <label for="noteInput">å¤‡æ³¨ï¼ˆé¥®é£Ÿã€è¯ç‰©ã€ç‰¹åˆ«æƒ…å†µç­‰ï¼‰</label>
          <textarea id="noteInput" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©å–æ°´å°‘ï¼Œåƒäº†å¾ˆå¤šè‚‰ï¼›æˆ–æœç”¨äº†æŸç§è¯ç‰©ã€è…¹éƒ¨ä¸é€‚ç­‰"></textarea>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary">ä¿å­˜è®°å½•</button>
        <button type="button" id="fillNowBtn" class="btn btn-secondary">ç”¨å½“å‰æ—¶é—´å¡«å……</button>
        <button type="button" id="cancelEditBtn" class="btn btn-text" style="display:none;">å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤æ–°å¢</button>
        <div id="editingTip" class="editing-tip" style="display:none;">
          æ­£åœ¨ç¼–è¾‘ä¸€æ¡å†å²è®°å½•ï¼Œä¿å­˜åä¼šè¦†ç›–åŸè®°å½•ã€‚
        </div>
      </form>
    </div>

    <!-- å†å²è®°å½•å¡ç‰‡ -->
    <div class="card">
      <div class="records-header">
        <div class="records-header-title">
          <span class="emoji">ğŸ“š</span>
          <span>å†å²è®°å½•</span>
        </div>
        <select id="filterDays" class="filter-select">
          <option value="3">æœ€è¿‘ 3 å¤©</option>
          <option value="7" selected>æœ€è¿‘ 7 å¤©</option>
          <option value="30">æœ€è¿‘ 30 å¤©</option>
          <option value="all">å…¨éƒ¨</option>
        </select>
      </div>
      <div id="recordList" class="record-list"></div>
    </div>

    <!-- å¤‡ä»½ä¸æ¢å¤å¡ç‰‡ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">â˜ï¸</span>
          <span>æ•°æ®å¤‡ä»½ä¸æ¢å¤</span>
        </div>
      </div>
      <div class="card-subtitle">å»ºè®®ä¸æ—¶å¯¼å‡ºä¸€ä»½å¤‡ä»½ï¼Œå‘åˆ°å¤‡å¿˜å½• / å¾®ä¿¡æ”¶è—é‡Œã€‚</div>

      <div class="form-row">
        <button type="button" id="exportBtn" class="btn btn-secondary">å¯¼å‡ºæ•°æ®ï¼ˆå¤åˆ¶å¤‡ä»½æ–‡æœ¬ï¼‰</button>
      </div>
      <div class="form-row">
        <label for="backupTextarea">å¤‡ä»½æ–‡æœ¬</label>
        <textarea id="backupTextarea" placeholder="ç‚¹å‡»ä¸Šæ–¹â€œå¯¼å‡ºæ•°æ®â€ä¼šåœ¨è¿™é‡Œç”Ÿæˆä¸€æ®µå¯å¤åˆ¶çš„å¤‡ä»½æ–‡æœ¬ï¼›ä¹Ÿå¯ä»¥æŠŠä¹‹å‰çš„å¤‡ä»½ç²˜è´´åˆ°è¿™é‡Œï¼Œå†ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®è¿›è¡Œæ¢å¤ã€‚"></textarea>
      </div>
      <button type="button" id="importBtn" class="btn btn-primary">ä»å¤‡ä»½æ–‡æœ¬å¯¼å…¥ï¼ˆè¦†ç›–å½“å‰æ•°æ®ï¼‰</button>
      <div class="backup-note">
        å¯¼å…¥æ“ä½œä¼šè¦†ç›–å½“å‰æ‰€æœ‰è®°å½•ï¼Œè¯·å…ˆç¡®è®¤å¤‡ä»½å†…å®¹æ— è¯¯ã€‚<br />
        å°å»ºè®®ï¼šå¯ä»¥ä»¥â€œæ—¥æœŸ + å­•å‘¨â€çš„æ–¹å¼ç»™å¤‡ä»½å‘½åï¼Œæ–¹ä¾¿ä»¥åå›é¡¾ã€‚
      </div>
    </div>

    <div class="footer-tip">
      æ¸©é¦¨æç¤ºï¼šå¦‚æœ‰æŒç»­ä¾¿ç§˜ã€è…¹æ³»ã€æ˜æ˜¾è…¹ç—›æˆ–å‡ºè¡€ç­‰æƒ…å†µï¼Œè¯·ç¬¬ä¸€æ—¶é—´è”ç³»åŒ»ç”Ÿæˆ–å°±åŒ»ï¼Œè¿™ä¸ªå°å·¥å…·åªç”¨äºæ—¥å¸¸è®°å½•å’Œè¾…åŠ©è§‚å¯Ÿ ğŸ˜Š
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'preg_poop_logs_v1';
    let currentEditingId = null; // æ­£åœ¨ç¼–è¾‘çš„è®°å½• idï¼ˆä¸º null è¡¨ç¤ºæ–°å¢ï¼‰

    function loadLogs() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('load error', e);
        return [];
      }
    }

    function saveLogs(logs) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
      } catch (e) {
        alert('ä¿å­˜å¤±è´¥ï¼šæœ¬åœ°å­˜å‚¨ç©ºé—´å¯èƒ½å·²æ»¡');
      }
    }

    function formatDateLabel(dateStr) {
      const today = new Date();
      const d = new Date(dateStr + 'T00:00:00');
      const diff = Math.floor((today - d) / (1000 * 60 * 60 * 24));
      if (diff === 0) return 'ä»Šå¤©';
      if (diff === 1) return 'æ˜¨å¤©';
      return dateStr;
    }

    // å–å¾—æœ€æ–°ä¸€æ¡è®°å½•
    function getLatestLog(logs) {
      if (!logs || !logs.length) return null;
      return logs.reduce((latest, cur) => {
        const tLatest = (latest.date || '') + ' ' + (latest.time || '00:00');
        const tCur = (cur.date || '') + ' ' + (cur.time || '00:00');
        return tCur > tLatest ? cur : latest;
      });
    }

    // æ›´æ–°â€œä¸Šæ¬¡æ’ä¾¿æ—¶é—´â€é¢æ¿
    function updateLastPoopPanel() {
      const textEl = document.getElementById('lastPoopText');
      if (!textEl) return;

      const logs = loadLogs();
      if (!logs.length) {
        textEl.innerHTML = 'æš‚æ— è®°å½•';
        textEl.classList.add('last-poop-text-empty');
        return;
      }

      const latest = getLatestLog(logs);
      if (!latest || !latest.date) {
        textEl.innerHTML = 'æš‚æ— è®°å½•';
        textEl.classList.add('last-poop-text-empty');
        return;
      }

      const dateTimeStr = `${latest.date}T${latest.time || '00:00'}`;
      const lastTime = new Date(dateTimeStr);
      const now = new Date();

      if (isNaN(lastTime.getTime())) {
        textEl.textContent = 'æœ€è¿‘ä¸€æ¡è®°å½•æ—¶é—´æ ¼å¼æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥æœŸå’Œæ—¶é—´ã€‚';
        textEl.classList.remove('last-poop-text-empty');
        return;
      }

      let diffMs = now - lastTime;

      if (diffMs < 0) {
        textEl.textContent = 'æœ€è¿‘ä¸€æ¡è®°å½•åœ¨æœªæ¥ï¼Œè¯·æ£€æŸ¥æ—¥æœŸæˆ–æ—¶é—´è®¾ç½®ã€‚';
        textEl.classList.remove('last-poop-text-empty');
        return;
      }

      const totalMinutes = Math.floor(diffMs / 60000);
      const days = Math.floor(totalMinutes / (24 * 60));
      const remainMin = totalMinutes - days * 24 * 60;
      const hours = Math.floor(remainMin / 60);
      const minutes = remainMin % 60;

      textEl.innerHTML = `
        <span class="dot"></span>
        <span>ä¸Šæ¬¡æ’ä¾¿ä¸º ${days}å¤©${hours}æ—¶${minutes}åˆ† å‰</span>
      `;
      textEl.classList.remove('last-poop-text-empty');
    }

    function renderList() {
      const container = document.getElementById('recordList');
      const filterValue = document.getElementById('filterDays').value;
      let logs = loadLogs();

      // æŒ‰æ—¶é—´å€’åº
      logs.sort((a, b) => {
        const t1 = a.date + ' ' + a.time;
        const t2 = b.date + ' ' + b.time;
        return t2.localeCompare(t1);
      });

      if (filterValue !== 'all') {
        const days = parseInt(filterValue, 10);
        const now = new Date();
        logs = logs.filter(log => {
          const d = new Date(log.date + 'T00:00:00');
          const diff = (now - d) / (1000 * 60 * 60 * 24);
          return diff <= days;
        });
      }

      if (!logs.length) {
        container.innerHTML = '<div class="empty-tip">æš‚æ— è®°å½•ï¼Œå¯ä»¥ä»ä»Šå¤©å¼€å§‹ä¸€ç‚¹ç‚¹è®°å½•ï½</div>';
        // å¦‚æœç­›é€‰åä¸ºç©ºï¼Œä¹Ÿè¦æ›´æ–°ä¸Šæ¬¡æ’ä¾¿é¢æ¿ï¼ˆæ ¹æ®å…¨éƒ¨è€Œä¸æ˜¯ç­›é€‰ï¼‰
        updateLastPoopPanel();
        return;
      }

      container.innerHTML = '';
      logs.forEach((log) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'record-item';

        const dateLabel = formatDateLabel(log.date);

        wrapper.innerHTML = `
          <div class="record-main">
            <div class="record-time">${dateLabel} ${log.time}</div>
            <div>
              <span class="record-tag">${log.shape}</span>
              <span class="record-tag">${log.amount}</span>
            </div>
          </div>
          <div class="record-sub">
            ${log.feeling ? ('æ„Ÿå—ï¼š' + log.feeling) : ''}
          </div>
          ${log.note ? `<div class="record-note">${log.note}</div>` : ''}
          <div class="record-actions">
            <button class="link-btn" data-action="edit" data-id="${log._id}">ç¼–è¾‘</button>
            <button class="link-btn link-btn-danger" data-action="delete" data-id="${log._id}">åˆ é™¤</button>
          </div>
        `;

        container.appendChild(wrapper);
      });

      container.onclick = function (e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');

        if (action === 'delete') {
          deleteLogById(id);
        } else if (action === 'edit') {
          startEditLog(id);
        }
      };

      // æ¸²æŸ“å®Œåˆ—è¡¨åæ›´æ–°â€œä¸Šæ¬¡æ’ä¾¿æ—¶é—´â€
      updateLastPoopPanel();
    }

    function deleteLogById(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
      const logs = loadLogs();
      const newLogs = logs.filter(item => item._id !== id);
      saveLogs(newLogs);
      if (currentEditingId === id) {
        resetEditState();
      }
      renderList();
    }

    function startEditLog(id) {
      const logs = loadLogs();
      const log = logs.find(item => item._id === id);
      if (!log) return;

      currentEditingId = id;

      document.getElementById('dateInput').value = log.date;
      document.getElementById('timeInput').value = log.time;
      document.getElementById('shapeInput').value = log.shape;
      document.getElementById('amountInput').value = log.amount;
      document.getElementById('feelingInput').value = log.feeling || '';
      document.getElementById('noteInput').value = log.note || '';

      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const editingTip = document.getElementById('editingTip');

      submitBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
      cancelEditBtn.style.display = 'inline-flex';
      editingTip.style.display = 'block';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetEditState() {
      currentEditingId = null;

      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const editingTip = document.getElementById('editingTip');

      submitBtn.textContent = 'ä¿å­˜è®°å½•';
      cancelEditBtn.style.display = 'none';
      editingTip.style.display = 'none';

      document.getElementById('shapeInput').value = '';
      document.getElementById('amountInput').value = '';
      document.getElementById('feelingInput').value = '';
      document.getElementById('noteInput').value = '';
    }

    function initForm() {
      const form = document.getElementById('poopForm');
      const dateInput = document.getElementById('dateInput');
      const timeInput = document.getElementById('timeInput');
      const fillNowBtn = document.getElementById('fillNowBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      fillNowBtn.addEventListener('click', () => {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mi = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hh}:${mi}`;
      });

      cancelEditBtn.addEventListener('click', () => {
        resetEditState();
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const date = dateInput.value;
        const time = timeInput.value;
        const shape = document.getElementById('shapeInput').value;
        const amount = document.getElementById('amountInput').value;
        const feeling = document.getElementById('feelingInput').value;
        const note = document.getElementById('noteInput').value.trim();

        if (!date || !time || !shape || !amount) {
          alert('è¯·è‡³å°‘å¡«å†™æ—¥æœŸã€æ—¶é—´ã€æ€§çŠ¶å’Œé‡');
          return;
        }

        const logs = loadLogs();

        if (currentEditingId) {
          const idx = logs.findIndex(item => item._id === currentEditingId);
          if (idx !== -1) {
            logs[idx] = {
              ...logs[idx],
              date,
              time,
              shape,
              amount,
              feeling,
              note
            };
          }
          saveLogs(logs);
          resetEditState();
        } else {
          const newLog = {
            _id: Date.now().toString() + Math.random().toString(16).slice(2),
            date,
            time,
            shape,
            amount,
            feeling,
            note,
            createdAt: new Date().toISOString()
          };
          logs.push(newLog);
          saveLogs(logs);

          document.getElementById('shapeInput').value = '';
          document.getElementById('amountInput').value = '';
          document.getElementById('feelingInput').value = '';
          document.getElementById('noteInput').value = '';
        }

        renderList();
      });

      document.getElementById('filterDays').addEventListener('change', renderList);
    }

    // ===== æ•°æ®å¯¼å‡º / å¯¼å…¥ =====
    function initBackup() {
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const textarea = document.getElementById('backupTextarea');

      exportBtn.addEventListener('click', () => {
        const logs = loadLogs();
        if (!logs.length) {
          alert('å½“å‰æ²¡æœ‰ä»»ä½•è®°å½•å¯ä»¥å¯¼å‡ºã€‚');
          textarea.value = '';
          return;
        }

        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          data: logs
        };

        textarea.value = JSON.stringify(payload, null, 2);
        textarea.focus();
        textarea.select();
        alert('å·²ç”Ÿæˆå¤‡ä»½æ–‡æœ¬ï¼Œè¯·é•¿æŒ‰é€‰æ‹©å¹¶å¤åˆ¶ï¼Œä¿å­˜åˆ°å¤‡å¿˜å½•æˆ–å…¶ä»–å®‰å…¨ä½ç½®ã€‚');
      });

      importBtn.addEventListener('click', () => {
        const text = textarea.value.trim();
        if (!text) {
          alert('è¯·å…ˆåœ¨ä¸Šé¢çš„æ–‡æœ¬æ¡†ä¸­ç²˜è´´ä¸€æ®µå¤‡ä»½æ–‡æœ¬ã€‚');
          return;
        }

        if (!confirm('å¯¼å…¥å¤‡ä»½ä¼šè¦†ç›–å½“å‰æ‰€æœ‰è®°å½•ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
          return;
        }

        try {
          const parsed = JSON.parse(text);
          let data = parsed;

          if (parsed && Array.isArray(parsed.data)) {
            data = parsed.data;
          }

          if (!Array.isArray(data)) {
            alert('å¤‡ä»½æ ¼å¼ä¸æ­£ç¡®ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®æ•°ç»„ã€‚');
            return;
          }

          saveLogs(data);
          resetEditState();
          renderList();
          updateLastPoopPanel();
          alert('å¯¼å…¥æˆåŠŸï¼å½“å‰æ•°æ®å·²è¢«å¤‡ä»½å†…å®¹è¦†ç›–ã€‚');
        } catch (e) {
          console.error(e);
          alert('è§£æå¤‡ä»½æ–‡æœ¬å¤±è´¥ï¼Œè¯·ç¡®è®¤ç²˜è´´å†…å®¹æ˜¯å®Œæ•´çš„ JSONã€‚');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initForm();
      renderList();
      initBackup();
      updateLastPoopPanel();
      // æ¯ 1 åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ä¸Šæ¬¡æ’ä¾¿æ—¶é—´æ˜¾ç¤º
      setInterval(updateLastPoopPanel, 60 * 1000);
    });
  </script>
</body>
</html>
