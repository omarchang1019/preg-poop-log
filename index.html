<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>孕期排便记录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- 图标（按你的实际文件名来改） -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", sans-serif;
      background: #f5f5f7;
      color: #222;
    }

    .app {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 12px;
      text-align: center;
    }

    .subtitle {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-bottom: 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #444;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      background: #fff;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0,122,255,0.12);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-row {
      margin-bottom: 10px;
    }

    .form-row-inline {
      display: flex;
      gap: 8px;
    }

    .form-row-inline .form-row {
      flex: 1;
      margin-bottom: 0;
    }

    .btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 10px 14px;
      font-size: 15px;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
    }

    .btn-primary {
      background: #007aff;
      color: #fff;
    }

    .btn-primary:active {
      background: #0062cc;
    }

    .btn-secondary {
      background: #f2f2f7;
      color: #333;
      font-size: 13px;
      margin-top: 6px;
    }

    .btn-secondary:active {
      background: #e0e0e5;
    }

    .btn-text {
      background: transparent;
      border-radius: 999px;
      border: 1px solid #ddd;
      margin-top: 6px;
      font-size: 13px;
    }

    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .records-header-title {
      font-size: 15px;
      font-weight: 600;
    }

    .filter-select {
      width: auto;
      padding: 4px 8px;
      font-size: 12px;
    }

    .record-list {
      max-height: 60vh;
      overflow-y: auto;
    }

    .record-item {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
    }

    .record-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 2px;
    }

    .record-time {
      font-size: 13px;
      font-weight: 500;
    }

    .record-tag {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f2f2f7;
      margin-left: 4px;
    }

    .record-sub {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }

    .record-note {
      font-size: 12px;
      color: #444;
      white-space: pre-wrap;
    }

    .record-actions {
      text-align: right;
      margin-top: 4px;
    }

    .link-btn {
      border: none;
      background: none;
      color: #007aff;
      font-size: 12px;
      padding: 2px 4px;
      cursor: pointer;
      margin-left: 4px;
    }

    .link-btn-danger {
      color: #ff3b30;
    }

    .empty-tip {
      font-size: 12px;
      color: #999;
      text-align: center;
      padding: 12px 4px;
    }

    .footer-tip {
      text-align: center;
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .editing-tip {
      margin-top: 6px;
      font-size: 11px;
      color: #cc6600;
      text-align: left;
    }

    .backup-note {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    @media (min-width: 600px) {
      body {
        background: #e5e5ea;
      }
      .app {
        padding: 20px 16px 40px;
      }
      #backupTextarea {
        min-height: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>孕期排便记录</h1>
    <div class="subtitle">数据保存在本机浏览器中 · 建议定期导出备份</div>

    <!-- 录入卡片 -->
    <div class="card">
      <div class="card-title">今日记录</div>
      <form id="poopForm">
        <div class="form-row-inline">
          <div class="form-row">
            <label for="dateInput">日期</label>
            <input type="date" id="dateInput" required />
          </div>
          <div class="form-row">
            <label for="timeInput">时间</label>
            <input type="time" id="timeInput" required />
          </div>
        </div>

        <div class="form-row">
          <label for="shapeInput">性状（大致形态）</label>
          <select id="shapeInput" required>
            <option value="">请选择</option>
            <option value="偏硬">偏硬</option>
            <option value="正常成形">正常成形</option>
            <option value="偏软">偏软</option>
            <option value="稀/接近腹泻">稀 / 接近腹泻</option>
          </select>
        </div>

        <div class="form-row">
          <label for="amountInput">量</label>
          <select id="amountInput" required>
            <option value="">请选择</option>
            <option value="少">少</option>
            <option value="中等">中等</option>
            <option value="多">多</option>
          </select>
        </div>

        <div class="form-row">
          <label for="feelingInput">排便感受</label>
          <select id="feelingInput">
            <option value="">可选</option>
            <option value="轻松">轻松</option>
            <option value="有点费劲">有点费劲</option>
            <option value="很费劲/便秘感">很费劲 / 便秘感</option>
            <option value="腹痛">腹痛</option>
            <option value="肛门不适">肛门不适</option>
          </select>
        </div>

        <div class="form-row">
          <label for="noteInput">备注（饮食、药物、特别情况等）</label>
          <textarea id="noteInput" placeholder="例如：今天喝水少，吃了很多肉；或服用了某种药物等"></textarea>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary">保存记录</button>
        <button type="button" id="fillNowBtn" class="btn btn-secondary">用当前时间填充</button>
        <button type="button" id="cancelEditBtn" class="btn btn-text" style="display:none;">取消编辑，恢复新增</button>
        <div id="editingTip" class="editing-tip" style="display:none;">
          正在编辑一条历史记录，保存后会覆盖原记录。
        </div>
      </form>
    </div>

    <!-- 历史记录卡片 -->
    <div class="card">
      <div class="records-header">
        <div class="records-header-title">历史记录</div>
        <select id="filterDays" class="filter-select">
          <option value="3">最近 3 天</option>
          <option value="7" selected>最近 7 天</option>
          <option value="30">最近 30 天</option>
          <option value="all">全部</option>
        </select>
      </div>
      <div id="recordList" class="record-list"></div>
    </div>

    <!-- 备份与恢复卡片 -->
    <div class="card">
      <div class="card-title">数据备份与恢复</div>
      <div class="form-row">
        <button type="button" id="exportBtn" class="btn btn-secondary">导出数据（复制备份）</button>
      </div>
      <div class="form-row">
        <label for="backupTextarea">备份文本</label>
        <textarea id="backupTextarea" placeholder="点击上面的“导出数据”会在这里生成一段可复制的备份文本；也可以在这里粘贴之前的备份，再点击下面的“从备份导入”。"></textarea>
      </div>
      <button type="button" id="importBtn" class="btn btn-primary">从备份文本导入（覆盖当前数据）</button>
      <div class="backup-note">
        导入会覆盖当前所有记录，请确保已经做好备份。建议：定期把导出文本保存到备忘录 / 云盘。
      </div>
    </div>

    <div class="footer-tip">
      温馨提示：如有持续便秘、腹泻或出血等情况，请及时咨询医生。
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'preg_poop_logs_v1';
    let currentEditingId = null; // 正在编辑的记录 id（为 null 表示新增）

    function loadLogs() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('load error', e);
        return [];
      }
    }

    function saveLogs(logs) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
      } catch (e) {
        alert('保存失败：本地存储空间可能已满');
      }
    }

    function formatDateLabel(dateStr) {
      const today = new Date();
      const d = new Date(dateStr + 'T00:00:00');
      const diff = Math.floor((today - d) / (1000 * 60 * 60 * 24));
      if (diff === 0) return '今天';
      if (diff === 1) return '昨天';
      return dateStr;
    }

    function renderList() {
      const container = document.getElementById('recordList');
      const filterValue = document.getElementById('filterDays').value;
      let logs = loadLogs();

      // 按时间倒序
      logs.sort((a, b) => {
        const t1 = a.date + ' ' + a.time;
        const t2 = b.date + ' ' + b.time;
        return t2.localeCompare(t1);
      });

      if (filterValue !== 'all') {
        const days = parseInt(filterValue, 10);
        const now = new Date();
        logs = logs.filter(log => {
          const d = new Date(log.date + 'T00:00:00');
          const diff = (now - d) / (1000 * 60 * 60 * 24);
          return diff <= days;
        });
      }

      if (!logs.length) {
        container.innerHTML = '<div class="empty-tip">暂无记录</div>';
        return;
      }

      container.innerHTML = '';
      logs.forEach((log) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'record-item';

        const dateLabel = formatDateLabel(log.date);

        wrapper.innerHTML = `
          <div class="record-main">
            <div class="record-time">${dateLabel} ${log.time}</div>
            <div>
              <span class="record-tag">${log.shape}</span>
              <span class="record-tag">${log.amount}</span>
            </div>
          </div>
          <div class="record-sub">
            ${log.feeling ? ('感受：' + log.feeling) : ''}
          </div>
          ${log.note ? `<div class="record-note">${log.note}</div>` : ''}
          <div class="record-actions">
            <button class="link-btn" data-action="edit" data-id="${log._id}">编辑</button>
            <button class="link-btn link-btn-danger" data-action="delete" data-id="${log._id}">删除</button>
          </div>
        `;

        container.appendChild(wrapper);
      });

      // 事件委托处理编辑 & 删除
      container.onclick = function (e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');

        if (action === 'delete') {
          deleteLogById(id);
        } else if (action === 'edit') {
          startEditLog(id);
        }
      };
    }

    function deleteLogById(id) {
      if (!confirm('确定要删除这条记录吗？')) return;
      const logs = loadLogs();
      const newLogs = logs.filter(item => item._id !== id);
      saveLogs(newLogs);
      if (currentEditingId === id) {
        resetEditState();
      }
      renderList();
    }

    function startEditLog(id) {
      const logs = loadLogs();
      const log = logs.find(item => item._id === id);
      if (!log) return;

      currentEditingId = id;

      document.getElementById('dateInput').value = log.date;
      document.getElementById('timeInput').value = log.time;
      document.getElementById('shapeInput').value = log.shape;
      document.getElementById('amountInput').value = log.amount;
      document.getElementById('feelingInput').value = log.feeling || '';
      document.getElementById('noteInput').value = log.note || '';

      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const editingTip = document.getElementById('editingTip');

      submitBtn.textContent = '保存修改';
      cancelEditBtn.style.display = 'inline-flex';
      editingTip.style.display = 'block';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetEditState() {
      currentEditingId = null;

      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const editingTip = document.getElementById('editingTip');

      submitBtn.textContent = '保存记录';
      cancelEditBtn.style.display = 'none';
      editingTip.style.display = 'none';

      document.getElementById('shapeInput').value = '';
      document.getElementById('amountInput').value = '';
      document.getElementById('feelingInput').value = '';
      document.getElementById('noteInput').value = '';
    }

    function initForm() {
      const form = document.getElementById('poopForm');
      const dateInput = document.getElementById('dateInput');
      const timeInput = document.getElementById('timeInput');
      const fillNowBtn = document.getElementById('fillNowBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      fillNowBtn.addEventListener('click', () => {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mi = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hh}:${mi}`;
      });

      cancelEditBtn.addEventListener('click', () => {
        resetEditState();
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const date = dateInput.value;
        const time = timeInput.value;
        const shape = document.getElementById('shapeInput').value;
        const amount = document.getElementById('amountInput').value;
        const feeling = document.getElementById('feelingInput').value;
        const note = document.getElementById('noteInput').value.trim();

        if (!date || !time || !shape || !amount) {
          alert('请至少填写日期、时间、性状和量');
          return;
        }

        const logs = loadLogs();

        if (currentEditingId) {
          const idx = logs.findIndex(item => item._id === currentEditingId);
          if (idx !== -1) {
            logs[idx] = {
              ...logs[idx],
              date,
              time,
              shape,
              amount,
              feeling,
              note
            };
          }
          saveLogs(logs);
          resetEditState();
        } else {
          const newLog = {
            _id: Date.now().toString() + Math.random().toString(16).slice(2),
            date,
            time,
            shape,
            amount,
            feeling,
            note,
            createdAt: new Date().toISOString()
          };
          logs.push(newLog);
          saveLogs(logs);

          document.getElementById('shapeInput').value = '';
          document.getElementById('amountInput').value = '';
          document.getElementById('feelingInput').value = '';
          document.getElementById('noteInput').value = '';
        }

        renderList();
      });

      document.getElementById('filterDays').addEventListener('change', renderList);
    }

    // ===== 数据导出 / 导入 =====
    function initBackup() {
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const textarea = document.getElementById('backupTextarea');

      exportBtn.addEventListener('click', () => {
        const logs = loadLogs();
        if (!logs.length) {
          alert('当前没有任何记录可以导出。');
          textarea.value = '';
          return;
        }

        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          data: logs
        };

        textarea.value = JSON.stringify(payload, null, 2);
        textarea.focus();
        textarea.select();
        alert('已生成备份文本，请长按选择并复制，保存到备忘录或其他地方。');
      });

      importBtn.addEventListener('click', () => {
        const text = textarea.value.trim();
        if (!text) {
          alert('请先在上面的文本框中粘贴一段备份文本。');
          return;
        }

        if (!confirm('导入备份会覆盖当前所有记录，确定继续吗？')) {
          return;
        }

        try {
          const parsed = JSON.parse(text);
          let data = parsed;

          if (parsed && Array.isArray(parsed.data)) {
            data = parsed.data;
          }

          if (!Array.isArray(data)) {
            alert('备份格式不正确：未找到有效的数据数组。');
            return;
          }

          saveLogs(data);
          resetEditState();
          renderList();
          alert('导入成功！当前数据已被备份内容覆盖。');
        } catch (e) {
          console.error(e);
          alert('解析备份文本失败，请确认粘贴内容是完整的 JSON。');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initForm();
      renderList();
      initBackup();
    });
  </script>
</body>
</html>
