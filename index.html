<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>孕期排便记录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", sans-serif;
      background: #f5f5f7;
      color: #222;
    }

    .app {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 12px;
      text-align: center;
    }

    .subtitle {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-bottom: 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #444;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      background: #fff;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0,122,255,0.12);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-row {
      margin-bottom: 10px;
    }

    .form-row-inline {
      display: flex;
      gap: 8px;
    }

    .form-row-inline .form-row {
      flex: 1;
      margin-bottom: 0;
    }

    .btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 10px 14px;
      font-size: 15px;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
    }

    .btn-primary {
      background: #007aff;
      color: #fff;
    }

    .btn-primary:active {
      background: #0062cc;
    }

    .btn-secondary {
      background: #f2f2f7;
      color: #333;
      font-size: 13px;
      margin-top: 6px;
    }

    .btn-secondary:active {
      background: #e0e0e5;
    }

    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .records-header-title {
      font-size: 15px;
      font-weight: 600;
    }

    .filter-select {
      width: auto;
      padding: 4px 8px;
      font-size: 12px;
    }

    .record-list {
      max-height: 60vh;
      overflow-y: auto;
    }

    .record-item {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
    }

    .record-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 2px;
    }

    .record-time {
      font-size: 13px;
      font-weight: 500;
    }

    .record-tag {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f2f2f7;
      margin-left: 4px;
    }

    .record-sub {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }

    .record-note {
      font-size: 12px;
      color: #444;
      white-space: pre-wrap;
    }

    .record-actions {
      text-align: right;
      margin-top: 2px;
    }

    .link-btn {
      border: none;
      background: none;
      color: #ff3b30;
      font-size: 12px;
      padding: 2px 4px;
      cursor: pointer;
    }

    .empty-tip {
      font-size: 12px;
      color: #999;
      text-align: center;
      padding: 12px 4px;
    }

    .footer-tip {
      text-align: center;
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    @media (min-width: 600px) {
      body {
        background: #e5e5ea;
      }
      .app {
        padding: 20px 16px 40px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>孕期排便记录</h1>
    <div class="subtitle">数据仅保存在本机浏览器中（localStorage） · 适合个人简单记录</div>

    <!-- 录入卡片 -->
    <div class="card">
      <div class="card-title">今日记录</div>
      <form id="poopForm">
        <div class="form-row-inline">
          <div class="form-row">
            <label for="dateInput">日期</label>
            <input type="date" id="dateInput" required />
          </div>
          <div class="form-row">
            <label for="timeInput">时间</label>
            <input type="time" id="timeInput" required />
          </div>
        </div>

        <div class="form-row">
          <label for="shapeInput">性状（大致形态）</label>
          <select id="shapeInput" required>
            <option value="">请选择</option>
            <option value="偏硬">偏硬</option>
            <option value="正常成形">正常成形</option>
            <option value="偏软">偏软</option>
            <option value="稀/接近腹泻">稀 / 接近腹泻</option>
          </select>
        </div>

        <div class="form-row">
          <label for="amountInput">量</label>
          <select id="amountInput" required>
            <option value="">请选择</option>
            <option value="少">少</option>
            <option value="中等">中等</option>
            <option value="多">多</option>
          </select>
        </div>

        <div class="form-row">
          <label for="feelingInput">排便感受</label>
          <select id="feelingInput">
            <option value="">可选</option>
            <option value="轻松">轻松</option>
            <option value="有点费劲">有点费劲</option>
            <option value="很费劲/便秘感">很费劲 / 便秘感</option>
            <option value="腹痛">腹痛</option>
            <option value="肛门不适">肛门不适</option>
          </select>
        </div>

        <div class="form-row">
          <label for="noteInput">备注（饮食、药物、特别情况等）</label>
          <textarea id="noteInput" placeholder="例如：今天喝水少，吃了很多肉；或服用了某种药物等"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">保存记录</button>
        <button type="button" id="fillNowBtn" class="btn btn-secondary">用当前时间填充</button>
      </form>
    </div>

    <!-- 列表卡片 -->
    <div class="card">
      <div class="records-header">
        <div class="records-header-title">历史记录</div>
        <select id="filterDays" class="filter-select">
          <option value="3">最近 3 天</option>
          <option value="7" selected>最近 7 天</option>
          <option value="30">最近 30 天</option>
          <option value="all">全部</option>
        </select>
      </div>
      <div id="recordList" class="record-list"></div>
    </div>

    <div class="footer-tip">
      温馨提示：如有持续便秘、腹泻或出血等情况，请及时咨询医生。
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'preg_poop_logs_v1';

    function loadLogs() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('load error', e);
        return [];
      }
    }

    function saveLogs(logs) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
      } catch (e) {
        alert('保存失败：本地存储空间可能已满');
      }
    }

    function formatDateLabel(dateStr) {
      const today = new Date();
      const d = new Date(dateStr + 'T00:00:00');
      const diff = Math.floor((today - d) / (1000 * 60 * 60 * 24));
      if (diff === 0) return '今天';
      if (diff === 1) return '昨天';
      return dateStr;
    }

    function renderList() {
      const container = document.getElementById('recordList');
      const filterValue = document.getElementById('filterDays').value;
      let logs = loadLogs();

      // 按时间倒序
      logs.sort((a, b) => {
        const t1 = a.date + ' ' + a.time;
        const t2 = b.date + ' ' + b.time;
        return t2.localeCompare(t1);
      });

      if (filterValue !== 'all') {
        const days = parseInt(filterValue, 10);
        const now = new Date();
        logs = logs.filter(log => {
          const d = new Date(log.date + 'T00:00:00');
          const diff = (now - d) / (1000 * 60 * 60 * 24);
          return diff <= days;
        });
      }

      if (!logs.length) {
        container.innerHTML = '<div class="empty-tip">暂无记录</div>';
        return;
      }

      container.innerHTML = '';
      logs.forEach((log) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'record-item';

        const dateLabel = formatDateLabel(log.date);

        wrapper.innerHTML = `
          <div class="record-main">
            <div class="record-time">${dateLabel} ${log.time}</div>
            <div>
              <span class="record-tag">${log.shape}</span>
              <span class="record-tag">${log.amount}</span>
            </div>
          </div>
          <div class="record-sub">
            ${log.feeling ? ('感受：' + log.feeling) : ''}
          </div>
          ${log.note ? `<div class="record-note">${log.note}</div>` : ''}
          <div class="record-actions">
            <button class="link-btn" data-id="${log._id}">删除</button>
          </div>
        `;

        container.appendChild(wrapper);
      });

      // 绑定删除按钮
      container.querySelectorAll('.link-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          deleteLogById(id);
        });
      });
    }

    function deleteLogById(id) {
      if (!confirm('确定要删除这条记录吗？')) return;
      const logs = loadLogs();
      const newLogs = logs.filter(item => item._id !== id);
      saveLogs(newLogs);
      renderList();
    }

    function initForm() {
      const form = document.getElementById('poopForm');
      const dateInput = document.getElementById('dateInput');
      const timeInput = document.getElementById('timeInput');
      const fillNowBtn = document.getElementById('fillNowBtn');

      // 默认填充今天日期
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      fillNowBtn.addEventListener('click', () => {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mi = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hh}:${mi}`;
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const date = dateInput.value;
        const time = timeInput.value;
        const shape = document.getElementById('shapeInput').value;
        const amount = document.getElementById('amountInput').value;
        const feeling = document.getElementById('feelingInput').value;
        const note = document.getElementById('noteInput').value.trim();

        if (!date || !time || !shape || !amount) {
          alert('请至少填写日期、时间、性状和量');
          return;
        }

        const logs = loadLogs();
        const newLog = {
          _id: Date.now().toString() + Math.random().toString(16).slice(2),
          date,
          time,
          shape,
          amount,
          feeling,
          note,
          createdAt: new Date().toISOString()
        };

        logs.push(newLog);
        saveLogs(logs);
        renderList();

        // 填完后清空除了日期
        document.getElementById('shapeInput').value = '';
        document.getElementById('amountInput').value = '';
        document.getElementById('feelingInput').value = '';
        document.getElementById('noteInput').value = '';
      });

      document.getElementById('filterDays').addEventListener('change', renderList);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initForm();
      renderList();
    });
  </script>
</body>
</html>
